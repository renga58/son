<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Han Analiz | FlashOdds Pro - Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <script>
        // Sayfa √∂nbellekten (geri tu≈üuyla) y√ºklenirse zorla yenile
        window.onpageshow = function(event) {
            if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
                window.location.reload();
            }
        };
    </script>

    <style>
        .input-score { width: 40px; padding: 6px; text-align: center; border-radius: 4px; border: 1px solid #45475a; background: #1e1e2e; color: white; font-weight: bold; }
        .btn { border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; margin-right: 5px; transition: 0.2s; }
        .btn-save { background-color: #a6e3a1; color: #1e1e2e; }
        .btn-delete { background-color: #f38ba8; color: #1e1e2e; }
        .btn-details { background-color: #89b4fa; color: #1e1e2e; } /* Mavi Detay Butonu */
        
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        tr { background-color: #313244; }
        td, th { padding: 15px; text-align: left; vertical-align: middle; }
        tr td:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; }
        tr td:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; }
        
        /* MODAL STƒ∞LLERƒ∞ */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: #1e1e2e; margin: 5% auto; padding: 20px; border: 1px solid #45475a;
            width: 90%; max-width: 500px; border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: white; }
        
        .stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #313244; }
        .stat-label { color: #bac2de; }
        .stat-val { font-weight: bold; color: white; }
        .stat-result { font-size: 18px; margin-left: 10px; }
    </style>
</head>
<body>
    <div style="width: 100%; max-width: 1000px; margin: 0 auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div style="text-align: right; margin-bottom: 10px;">
                <span style="color: #cdd6f4; margin-right: 10px;">üë§ {{ current_user.username }}</span>
                <a href="/logout" style="color: #f38ba8; text-decoration: none; font-size: 14px;">√áƒ±kƒ±≈ü Yap üö™</a>
            </div>
            <h1>üìä Performans Paneli</h1>
            <a href="/analyze" class="btn" style="background:#89b4fa; text-decoration:none; padding:10px 20px;">‚¨ÖÔ∏è Yeni Analiz</a>
        </div>

        <h2 style="color:#f9e2af; border-bottom:2px solid #45475a; margin-top:40px;">‚è≥ Skor Bekleyenler</h2>
        <table>
            <thead><tr><th>Ma√ß</th><th>Tahmin</th><th>Skor Gir</th><th>ƒ∞≈ülem</th></tr></thead>
            <tbody>
                {% for r in pending %}
                <tr id="row-{{ r[0] }}" data-probs='{{ r[11] | safe }}' data-home="{{ r[3] }}" data-away="{{ r[4] }}" data-score="">
                    <td>
                        <div style="font-weight:bold;">{{ r[3] }} vs {{ r[4] }}</div>
                        <div style="font-size:12px; color:#bac2de;">{{ r[1] }}</div>
                    </td>
                    <td><span style="background:#45475a; padding:4px 8px; border-radius:4px; color:#fab387;">{{ r[5] }} (%{{ r[6] }})</span></td>
                    <td>
                        <input type="number" id="hg-{{ r[0] }}" class="input-score" placeholder="E"> - 
                        <input type="number" id="ag-{{ r[0] }}" class="input-score" placeholder="D">
                    </td>
                    <td>
                        <button class="btn btn-save" onclick="saveScore({{ r[0] }})">üíæ</button>
                        <button class="btn btn-details" onclick="openModal({{ r[0] }})">üëÅÔ∏è</button>
                        <button class="btn btn-delete" onclick="deleteMatch({{ r[0] }})">üóëÔ∏è</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h2 style="color:#f9e2af; border-bottom:2px solid #45475a; margin-top:40px;">‚úÖ Sonu√ßlananlar</h2>
        <table>
            <thead><tr><th>Ma√ß</th><th>Sonu√ß</th><th>Durum</th><th>ƒ∞≈ülem</th></tr></thead>
            <tbody>
                {% for r in finished %}
                <tr id="row-{{ r[0] }}" data-probs='{{ r[11] | safe }}' data-home="{{ r[3] }}" data-away="{{ r[4] }}" data-score="{{ r[7] }}-{{ r[8] }}">
                    <td>
                        <div style="font-weight:bold;">{{ r[3] }} - {{ r[4] }}</div>
                        <div style="font-size:12px; color:#bac2de;">{{ r[1] }}</div>
                    </td>
                    <td>
                        <span style="font-size:16px; font-weight:bold; color:white;">{{ r[7] }} - {{ r[8] }}</span>
                        <div style="font-size:11px; color:#a6adc8;">Tahmin: {{ r[5] }}</div>
                    </td>
                    <td>
                        {{ "‚úÖ KAZANDI" if r[10] == 1 else "‚ùå KAYBETTƒ∞" }}
                    </td>
                    <td>
                        <button class="btn btn-details" onclick="openModal({{ r[0] }})">üëÅÔ∏è DETAY</button>
                        <button class="btn btn-delete" onclick="deleteMatch({{ r[0] }})">üóëÔ∏è</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle" style="color:#89b4fa; border-bottom:1px solid #45475a; padding-bottom:10px;">Ma√ß Detayƒ±</h2>
            <div id="modalScore" style="text-align:center; font-size:24px; margin:10px 0; font-weight:bold; color:#f9e2af;"></div>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // MODAL ƒ∞≈ûLEMLERƒ∞
        const modal = document.getElementById("detailModal");
        
        function openModal(rowId) {
            const row = document.getElementById(`row-${rowId}`);
            const probs = JSON.parse(row.dataset.probs);
            const home = row.dataset.home;
            const away = row.dataset.away;
            const scoreStr = row.dataset.score; // "2-1" gibi
            
            document.getElementById("modalTitle").innerText = `${home} vs ${away}`;
            
            let hg = -1, ag = -1;
            if(scoreStr) {
                document.getElementById("modalScore").innerText = `Skor: ${scoreStr}`;
                const parts = scoreStr.split('-');
                hg = parseInt(parts[0]);
                ag = parseInt(parts[1]);
            } else {
                document.getElementById("modalScore").innerText = "‚è≥ Ma√ß Bekleniyor";
            }

            let html = "";
            
            // Tahmini skoru g√∂ster
            if(probs["Tahmini Skor"]) {
                html += `<div style="text-align:center; margin-bottom:15px; color:#bac2de;">Sistemin Skor Tahmini: <b style="color:white;">${probs["Tahmini Skor"]}</b></div>`;
                delete probs["Tahmini Skor"];
            }

            // T√ºm ihtimalleri listele
            for (const [market, data] of Object.entries(probs)) {
                let statusIcon = "";
                
                // EƒûER SKOR VARSA KONTROL ET (Akƒ±llƒ± Kontrol)
                if(hg !== -1) {
                    let isWin = false;
                    if(market === "MS 1" && hg > ag) isWin = true;
                    else if(market === "MS 2" && ag > hg) isWin = true;
                    else if(market === "Beraberlik" && hg === ag) isWin = true;
                    else if(market === "2.5 √úst" && (hg+ag) > 2.5) isWin = true;
                    else if(market === "2.5 Alt" && (hg+ag) < 2.5) isWin = true;
                    else if(market === "KG Var" && (hg>0 && ag>0)) isWin = true;
                    else if(market === "KG Yok" && (hg===0 || ag===0)) isWin = true;
                    
                    statusIcon = isWin ? "‚úÖ" : "‚ùå";
                }

                html += `
                    <div class="stat-row">
                        <span class="stat-label">${market}</span>
                        <div>
                            <span style="font-size:11px; color:#f9e2af; margin-right:5px;">${data.label}</span>
                            <span class="stat-val">%${data.percent}</span>
                            <span class="stat-result">${statusIcon}</span>
                        </div>
                    </div>
                    <div style="background:#45475a; height:6px; border-radius:3px; margin-bottom:5px;">
                        <div style="background:${data.percent > 50 ? '#a6e3a1' : '#89b4fa'}; width:${data.percent}%; height:100%; border-radius:3px;"></div>
                    </div>
                `;
            }
            
            document.getElementById("modalContent").innerHTML = html;
            modal.style.display = "block";
        }

        function closeModal() { modal.style.display = "none"; }
        window.onclick = function(event) { if (event.target == modal) closeModal(); }

        // KAYDET & Sƒ∞L (Eski fonksiyonlar)
        async function saveScore(id) {
            const hg = document.getElementById(`hg-${id}`).value;
            const ag = document.getElementById(`ag-${id}`).value;
            if(hg===""||ag==="") return alert("Skor gir!");
            await fetch("/api/update_score", {
                method:"POST", headers:{"Content-Type":"application/json"},
                body: JSON.stringify({id, hg, ag})
            });
            location.reload();
        }

        async function deleteMatch(id) {
            if(confirm("Silmek istiyor musun?")) {
                await fetch("/api/delete_match", {
                    method:"POST", headers:{"Content-Type":"application/json"},
                    body: JSON.stringify({id})
                });
                document.getElementById(`row-${id}`).remove();
            }
        }
    </script>
</body>
</html>